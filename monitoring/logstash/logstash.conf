input {
  # Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ íŒŒì¼ ìž…ë ¥
  file {
    path => "/var/log/autocoin/*.log"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/sincedb"
    codec => multiline {
      pattern => "^%{TIMESTAMP_ISO8601}"
      negate => true
      what => "previous"
      max_lines => 500
      max_bytes => "10MB"
    }
    tags => ["autocoin-app", "file-input"]
  }
  
  # Docker ì»¨í…Œì´ë„ˆ ë¡œê·¸ (Filebeat í†µí•´ ìž…ë ¥)
  beats {
    port => 5044
    type => "logs"
  }
  
  # TCP ìž…ë ¥ (ì‹¤ì‹œê°„ ë¡œê·¸ ìŠ¤íŠ¸ë¦¬ë°ìš©)
  tcp {
    port => 5000
    codec => json_lines
    tags => ["tcp-input"]
  }
  
  # Nginx ì•¡ì„¸ìŠ¤ ë¡œê·¸
  file {
    path => "/var/log/nginx/access.log"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/nginx-sincedb"
    tags => ["nginx", "access-log"]
  }
  
  # Nginx ì—ëŸ¬ ë¡œê·¸
  file {
    path => "/var/log/nginx/error.log"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/nginx-error-sincedb"
    tags => ["nginx", "error-log"]
  }
}

filter {
  # ===== Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ì²˜ë¦¬ =====
  if "autocoin-app" in [tags] {
    # ê¸°ë³¸ Spring Boot ë¡œê·¸ íŒ¨í„´ íŒŒì‹±
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp}\s+\[%{DATA:thread}\]\s+(?:\[%{DATA:trace_id}\]\s+)?%{LOGLEVEL:level}\s+%{DATA:logger}\s+-\s+%{GREEDYDATA:log_message}"
      }
      tag_on_failure => ["_grokparsefailure_spring_basic"]
    }
    
    # ëŒ€ì²´ íŒ¨í„´ (íŠ¸ë ˆì´ìŠ¤ IDê°€ ì—†ëŠ” ê²½ìš°)
    if "_grokparsefailure_spring_basic" in [tags] {
      grok {
        match => { 
          "message" => "%{TIMESTAMP_ISO8601:timestamp}\s+\[%{DATA:thread}\]\s+%{LOGLEVEL:level}\s+%{DATA:logger}\s+-\s+%{GREEDYDATA:log_message}"
        }
        tag_on_failure => ["_grokparsefailure_spring_alt"]
      }
    }
    
    # íƒ€ìž„ìŠ¤íƒ¬í”„ íŒŒì‹±
    if [timestamp] {
      date {
        match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS", "yyyy-MM-dd HH:mm:ss,SSS" ]
        target => "@timestamp"
      }
    }
    
    # ë¡œê·¸ ë ˆë²¨ë³„ ë©”íƒ€ë°ì´í„° ì¶”ê°€
    if [level] == "ERROR" {
      mutate {
        add_field => { 
          "severity" => "high"
          "alert_type" => "error"
          "priority" => "1"
        }
        add_tag => ["error-log"]
      }
    } else if [level] == "WARN" {
      mutate {
        add_field => { 
          "severity" => "medium"
          "alert_type" => "warning"
          "priority" => "2"
        }
        add_tag => ["warning-log"]
      }
    } else if [level] == "INFO" {
      mutate {
        add_field => { 
          "severity" => "low"
          "alert_type" => "info"
          "priority" => "3"
        }
        add_tag => ["info-log"]
      }
    } else if [level] == "DEBUG" {
      mutate {
        add_field => { 
          "severity" => "very_low"
          "alert_type" => "debug"
          "priority" => "4"
        }
        add_tag => ["debug-log"]
      }
    }
    
    # ===== ì—ëŸ¬ íŒ¨í„´ ê°ì§€ ë° ë¶„ë¥˜ =====
    if [log_message] {
      # SQL ê´€ë ¨ ì—ëŸ¬
      if [log_message] =~ /SQLException|DatabaseException|Connection.*failed|Deadlock/ {
        mutate {
          add_field => { 
            "error_category" => "database"
            "requires_attention" => "true"
          }
          add_tag => ["database-error"]
        }
      }
      
      # HTTP/API ê´€ë ¨ ì—ëŸ¬
      else if [log_message] =~ /HttpException|RestClientException|Connection.*timeout|HTTP.*error/ {
        mutate {
          add_field => { 
            "error_category" => "external_api"
            "requires_attention" => "true"
          }
          add_tag => ["api-error"]
        }
      }
      
      # ë©”ëª¨ë¦¬ ê´€ë ¨ ì—ëŸ¬
      else if [log_message] =~ /OutOfMemoryError|MemoryError|Heap.*space/ {
        mutate {
          add_field => { 
            "error_category" => "memory"
            "requires_attention" => "critical"
          }
          add_tag => ["memory-error", "critical-error"]
        }
      }
      
      # ë³´ì•ˆ ê´€ë ¨ ì—ëŸ¬
      else if [log_message] =~ /SecurityException|AuthenticationException|Unauthorized|Access.*denied/ {
        mutate {
          add_field => { 
            "error_category" => "security"
            "requires_attention" => "true"
          }
          add_tag => ["security-error"]
        }
      }
      
      # ì¼ë°˜ ì˜ˆì™¸
      else if [log_message] =~ /Exception|Error|Failed|NullPointerException/ {
        mutate {
          add_field => { 
            "error_category" => "application"
            "error_detected" => "true"
          }
          add_tag => ["application-error"]
        }
      }
      
      # ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤ ê°ì§€
      if [log_message] =~ /at\s+[\w\.$]+\([\w\.]+:\d+\)/ {
        mutate {
          add_field => { "has_stacktrace" => "true" }
          add_tag => ["stacktrace"]
        }
      }
    }
    
    # ===== ì„œë¹„ìŠ¤ ì»´í¬ë„ŒíŠ¸ ì‹ë³„ =====
    if [logger] {
      # ì»¨íŠ¸ë¡¤ëŸ¬ ë¡œê·¸
      if [logger] =~ /controller/ {
        mutate { add_field => { "service_component" => "controller" } }
      }
      # ì„œë¹„ìŠ¤ ë¡œê·¸
      else if [logger] =~ /service/ {
        mutate { add_field => { "service_component" => "service" } }
      }
      # ë¦¬í¬ì§€í† ë¦¬/DAO ë¡œê·¸
      else if [logger] =~ /repository|dao/ {
        mutate { add_field => { "service_component" => "repository" } }
      }
      # ì—…ë¹„íŠ¸ API ê´€ë ¨
      else if [logger] =~ /upbit/ {
        mutate { add_field => { "service_component" => "upbit" } }
      }
      # ì¸ì¦/ë³´ì•ˆ ê´€ë ¨
      else if [logger] =~ /auth|security|jwt/ {
        mutate { add_field => { "service_component" => "auth" } }
      }
      # ë‰´ìŠ¤ ìˆ˜ì§‘ ê´€ë ¨
      else if [logger] =~ /news|crawler/ {
        mutate { add_field => { "service_component" => "news" } }
      }
    }
    
    # ===== HTTP API ìš”ì²­ ë¡œê·¸ íŒŒì‹± =====
    if [log_message] =~ /(GET|POST|PUT|DELETE|PATCH)\s+\/.*HTTP/ {
      grok {
        match => { 
          "log_message" => "%{WORD:http_method}\s+%{URIPATH:endpoint}(?:%{URIPARAM:params})?\s+HTTP/%{NUMBER:http_version}\s+-\s+%{NUMBER:http_status}\s+-\s+%{NUMBER:duration}ms(?:\s+-\s+IP:\s+%{IP:client_ip})?"
        }
        tag_on_failure => ["_api_parse_failure"]
      }
      
      if ![_api_parse_failure] {
        mutate {
          add_field => { "log_type" => "api_request" }
          convert => { 
            "http_status" => "integer"
            "duration" => "integer"
            "http_version" => "float"
          }
          add_tag => ["api-request"]
        }
        
        # ëŠë¦° ì‘ë‹µ ê°ì§€ (1ì´ˆ ì´ìƒ)
        if [duration] and [duration] > 1000 {
          mutate {
            add_field => { 
              "slow_request" => "true"
              "performance_issue" => "true"
            }
            add_tag => ["slow-response"]
          }
        }
        
        # ë§¤ìš° ëŠë¦° ì‘ë‹µ (5ì´ˆ ì´ìƒ)
        if [duration] and [duration] > 5000 {
          mutate {
            add_field => { "critical_slow_request" => "true" }
            add_tag => ["critical-slow-response"]
          }
        }
        
        # HTTP ì—ëŸ¬ ìƒíƒœ ë¶„ë¥˜
        if [http_status] {
          if [http_status] >= 500 {
            mutate {
              add_field => { 
                "http_error_type" => "server_error"
                "requires_attention" => "true"
              }
              add_tag => ["http-5xx"]
            }
          } else if [http_status] >= 400 {
            mutate {
              add_field => { "http_error_type" => "client_error" }
              add_tag => ["http-4xx"]
            }
          } else if [http_status] >= 200 and [http_status] < 300 {
            mutate {
              add_field => { "http_success" => "true" }
              add_tag => ["http-success"]
            }
          }
        }
      }
    }
    
    # ===== ì‚¬ìš©ìž í™œë™ ë¡œê·¸ íŒŒì‹± =====
    if [log_message] =~ /(Login|Logout|Register|Failed.*authentication)/ {
      mutate {
        add_field => { "log_type" => "user_activity" }
        add_tag => ["user-activity"]
      }
      
      # ë¡œê·¸ì¸ ì‹œë„ íŒŒì‹±
      if [log_message] =~ /Login\s+attempt.*user:\s*(\w+)/ {
        grok {
          match => { "log_message" => "Login\s+attempt.*user:\s*%{WORD:username}.*IP:\s*%{IP:login_ip}" }
        }
        mutate { add_tag => ["login-attempt"] }
      }
      
      # ë¡œê·¸ì¸ ì‹¤íŒ¨ ê°ì§€
      if [log_message] =~ /(Failed|Invalid).*authentication/ {
        mutate {
          add_field => { 
            "security_event" => "authentication_failure"
            "requires_attention" => "true"
          }
          add_tag => ["auth-failure", "security-event"]
        }
      }
    }
    
    # ===== ë¹„ì¦ˆë‹ˆìŠ¤ ë©”íŠ¸ë¦­ ì¶”ì¶œ =====
    # ì‚¬ìš©ìž ë“±ë¡
    if [log_message] =~ /User.*registered.*ID:\s*(\d+)/ {
      grok {
        match => { "log_message" => "User.*registered.*ID:\s*%{NUMBER:user_id}" }
      }
      mutate {
        add_field => { 
          "business_event" => "user_registration"
          "metric_type" => "user_growth"
        }
        add_tag => ["business-metric", "user-registration"]
      }
    }
    
    # ê±°ëž˜ í™œë™
    if [log_message] =~ /(Trade|Order).*executed/ {
      mutate {
        add_field => { 
          "business_event" => "trade_activity"
          "metric_type" => "trading"
        }
        add_tag => ["business-metric", "trading"]
      }
    }
  }
  
  # ===== Nginx ë¡œê·¸ ì²˜ë¦¬ =====
  if "nginx" in [tags] {
    if "access-log" in [tags] {
      grok {
        match => { 
          "message" => "%{NGINXACCESS}"
        }
        patterns_dir => ["/usr/share/logstash/patterns"]
      }
      
      if [response] {
        mutate {
          convert => { "response" => "integer" }
        }
      }
      
      mutate {
        add_field => { "log_type" => "nginx_access" }
        add_tag => ["nginx-access"]
      }
    } 
    
    if "error-log" in [tags] {
      mutate {
        add_field => { "log_type" => "nginx_error" }
        add_tag => ["nginx-error"]
      }
    }
  }
  
  # ===== ê³µí†µ í•„ë“œ ì¶”ê°€ =====
  mutate {
    add_field => { 
      "application" => "autocoin-api"
      "environment" => "${ENVIRONMENT:production}"
      "version" => "${APP_VERSION:1.0.0}"
      "processed_at" => "%{@timestamp}"
    }
  }
  
  # ===== ì§€ë¦¬ì  ì •ë³´ ì¶”ê°€ (í´ë¼ì´ì–¸íŠ¸ IP ê¸°ë°˜) =====
  if [client_ip] and [client_ip] != "127.0.0.1" and [client_ip] !~ /^10\./ and [client_ip] !~ /^192\.168\./ {
    geoip {
      source => "client_ip"
      target => "geoip"
      add_tag => ["geoip"]
    }
  }
  
  # ===== ë¶ˆí•„ìš”í•œ í•„ë“œ ì •ë¦¬ =====
  mutate {
    remove_field => [ "host", "path", "input", "agent" ]
    remove_tag => ["_grokparsefailure_spring_basic", "_grokparsefailure_spring_alt"]
  }
  
  # ===== ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹ =====
  if [log_message] {
    # ë¹„ë°€ë²ˆí˜¸ ë§ˆìŠ¤í‚¹
    mutate {
      gsub => [ 
        "log_message", "password['\"]?\s*[:=]\s*['\"]?[^'\",\s]+", "password=***MASKED***",
        "log_message", "token['\"]?\s*[:=]\s*['\"]?[^'\",\s]+", "token=***MASKED***",
        "log_message", "secret['\"]?\s*[:=]\s*['\"]?[^'\",\s]+", "secret=***MASKED***"
      ]
    }
  }
}

output {
  # ===== Elasticsearch ë©”ì¸ ì¶œë ¥ =====
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "autocoin-logs-%{+YYYY.MM.dd}"
    template_overwrite => true
    template => "/usr/share/logstash/templates/autocoin-template.json"
    template_name => "autocoin"
    document_type => "_doc"
    
    # ë¬¸ì„œ ID ìƒì„± (ì¤‘ë³µ ë°©ì§€)
    document_id => "%{[@metadata][fingerprint]}"
  }
  
  # ===== ì—ëŸ¬ ë¡œê·¸ ë³„ë„ ì¸ë±ìŠ¤ =====
  if [level] == "ERROR" or "error-log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "autocoin-errors-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # ===== ë³´ì•ˆ ì´ë²¤íŠ¸ ë³„ë„ ì¸ë±ìŠ¤ =====
  if "security-event" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "autocoin-security-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # ===== ë¹„ì¦ˆë‹ˆìŠ¤ ë©”íŠ¸ë¦­ ë³„ë„ ì¸ë±ìŠ¤ =====
  if "business-metric" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "autocoin-metrics-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # ===== ì„±ëŠ¥ ë¬¸ì œ ë³„ë„ ì¸ë±ìŠ¤ =====
  if "slow-response" in [tags] or "critical-slow-response" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "autocoin-performance-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # ===== ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ ì½˜ì†” ì¶œë ¥ =====
  if "${ENVIRONMENT:production}" != "production" {
    stdout { 
      codec => rubydebug {
        metadata => false
      }
    }
  }
  
  # ===== Critical ì—ëŸ¬ ì¦‰ì‹œ ì•Œë¦¼ (Webhook) =====
  if "critical-error" in [tags] or [requires_attention] == "critical" {
    http {
      url => "${SLACK_WEBHOOK_URL}"
      http_method => "post"
      content_type => "application/json"
      format => "json"
      mapping => {
        "text" => "ðŸš¨ Critical Error Detected in Autocoin API: %{log_message}"
        "channel" => "#critical-alerts"
        "username" => "LogstashBot"
      }
    }
  }
}
