name: ğŸ”„ Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to rollback to (e.g., v1.2.3, latest-stable, previous)'
        required: true
        type: string
        default: 'previous'
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      confirm:
        description: 'Type "CONFIRM" to proceed with rollback'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/autocoin-api

permissions:
  contents: read
  packages: read

jobs:
  validate-rollback:
    name: ğŸ” Validate Rollback Request
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    outputs:
      target-version: ${{ steps.version.outputs.target }}
      rollback-approved: ${{ steps.validate.outputs.approved }}
    
    steps:
      - name: Validate confirmation
        id: validate
        run: |
          if [ "${{ inputs.confirm }}" != "CONFIRM" ]; then
            echo "âŒ Rollback not confirmed. Please type 'CONFIRM' to proceed."
            exit 1
          fi
          
          if [ -z "${{ inputs.reason }}" ]; then
            echo "âŒ Rollback reason is required."
            exit 1
          fi
          
          echo "âœ… Rollback request validated"
          echo "approved=true" >> $GITHUB_OUTPUT

      - name: Determine target version
        id: version
        run: |
          TARGET_VERSION="${{ inputs.version }}"
          
          case "$TARGET_VERSION" in
            "previous")
              echo "ğŸ” Finding previous stable version..."
              TARGET_VERSION="latest-stable"
              ;;
            "latest-stable")
              TARGET_VERSION="latest-stable"
              ;;
            *)
              if [[ ! "$TARGET_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                echo "âš ï¸ Custom version format detected: $TARGET_VERSION"
              fi
              ;;
          esac
          
          echo "ğŸ¯ Target version: $TARGET_VERSION"
          echo "target=$TARGET_VERSION" >> $GITHUB_OUTPUT

      - name: Log rollback request
        run: |
          echo "ğŸ“‹ Rollback Request Summary:"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Target Version: ${{ steps.version.outputs.target }}"
          echo "  Reason: ${{ inputs.reason }}"
          echo "  Requested by: ${{ github.actor }}"
          echo "  Request time: $(date -u)"

  pre-rollback-backup:
    name: ğŸ’¾ Pre-Rollback Backup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate-rollback]
    if: needs.validate-rollback.outputs.rollback-approved == 'true'
    
    steps:
      - name: Create current state backup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.environment == 'production' && secrets.EC2_HOST || secrets.STAGING_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            echo "ğŸ’¾ Creating pre-rollback backup..."
            
            BACKUP_DIR="/opt/autocoin/rollback-backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_NAME="pre-rollback-${TIMESTAMP}"
            
            mkdir -p $BACKUP_DIR
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì •ë³´ ë°±ì—…
            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}" > $BACKUP_DIR/${BACKUP_NAME}_containers.txt
            
            # í˜„ì¬ ì´ë¯¸ì§€ íƒœê·¸ ë°±ì—…
            docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}" | grep autocoin > $BACKUP_DIR/${BACKUP_NAME}_images.txt
            
            # í™˜ê²½ ë³€ìˆ˜ ë°±ì—…
            if [ -f "/opt/autocoin/.env.prod" ]; then
              cp /opt/autocoin/.env.prod $BACKUP_DIR/${BACKUP_NAME}_env.backup
            fi
            
            echo "âœ… Backup completed: $BACKUP_NAME"

  rollback-production:
    name: ğŸ”„ Rollback Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [validate-rollback, pre-rollback-backup]
    if: inputs.environment == 'production'
    environment:
      name: production-rollback
      url: https://api.autocoin.com
    
    steps:
      - name: Execute production rollback
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            echo "ğŸ”„ Starting production rollback..."
            
            TARGET_VERSION="${{ needs.validate-rollback.outputs.target-version }}"
            IMAGE_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TARGET_VERSION"
            CONTAINER_NAME="autocoin-api-prod"
            
            echo "Rolling back to: $IMAGE_NAME"
            
            # GitHub Container Registry ë¡œê·¸ì¸
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull target image
            echo "ğŸ“¦ Pulling target image..."
            docker pull $IMAGE_NAME
            
            # Create additional backup of current container
            echo "ğŸ’¾ Creating additional backup..."
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            docker commit $CONTAINER_NAME autocoin-api-backup:$TIMESTAMP || true
            
            # Stop current container gracefully
            echo "ğŸ›‘ Stopping current container gracefully..."
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true
            
            # Start with target version
            echo "ğŸš€ Starting with target version..."
            cd /opt/autocoin
            
            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              -p 8080:8080 \
              --env-file .env.prod \
              -v /opt/autocoin/logs:/app/logs \
              $IMAGE_NAME
            
            # Extended health check for production
            echo "â³ Waiting for application to start..."
            RETRY_COUNT=0
            MAX_RETRIES=60
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -sf http://localhost:8080/actuator/health > /dev/null; then
                echo "âœ… Production rollback completed successfully!"
                break
              fi
              
              echo "Waiting for application... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Application failed to start after rollback"
              docker logs $CONTAINER_NAME --tail 50
              exit 1
            fi
            
            # Verify rollback
            echo "ğŸ“‹ Rollback verification:"
            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}" | grep $CONTAINER_NAME

  rollback-staging:
    name: ğŸ”„ Rollback Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate-rollback, pre-rollback-backup]
    if: inputs.environment == 'staging'
    environment:
      name: staging-rollback
      url: https://api-staging.autocoin.com
    
    steps:
      - name: Execute staging rollback
        run: |
          echo "ğŸ”„ Staging rollback simulation..."
          echo "Target version: ${{ needs.validate-rollback.outputs.target-version }}"
          echo "âœ… Staging rollback would be executed here"

  post-rollback-verification:
    name: âœ… Post-Rollback Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [rollback-staging, rollback-production]
    if: always() && (needs.rollback-staging.result == 'success' || needs.rollback-production.result == 'success')
    
    steps:
      - name: Verify rollback success
        run: |
          ENVIRONMENT="${{ inputs.environment }}"
          TARGET_VERSION="${{ needs.validate-rollback.outputs.target-version }}"
          
          echo "ğŸ” Verifying rollback to $TARGET_VERSION on $ENVIRONMENT"
          echo "âœ… Rollback verification completed"

  notify-rollback:
    name: ğŸ“¢ Rollback Notification
    runs-on: ubuntu-latest
    needs: [validate-rollback, rollback-staging, rollback-production, post-rollback-verification]
    if: always()
    
    steps:
      - name: Determine rollback result
        id: result
        run: |
          if [ "${{ needs.rollback-staging.result }}" = "success" ] || [ "${{ needs.rollback-production.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack - Success
        if: steps.result.outputs.status == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#critical-alerts'
          text: |
            ğŸ”„ *ê¸´ê¸‰ ë¡¤ë°± ì™„ë£Œ*
            
            â€¢ **Environment**: ${{ inputs.environment }}
            â€¢ **Target Version**: ${{ needs.validate-rollback.outputs.target-version }}
            â€¢ **Reason**: ${{ inputs.reason }}
            â€¢ **Executed by**: ${{ github.actor }}
            
            âœ… **Status**: ë¡¤ë°± ì„±ê³µ
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack - Failure
        if: steps.result.outputs.status == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#critical-alerts'
          text: |
            ğŸš¨ *ê¸´ê¸‰ ë¡¤ë°± ì‹¤íŒ¨*
            
            â€¢ **Environment**: ${{ inputs.environment }}
            â€¢ **Target Version**: ${{ needs.validate-rollback.outputs.target-version }}
            â€¢ **Reason**: ${{ inputs.reason }}
            â€¢ **Executed by**: ${{ github.actor }}
            
            âŒ **Status**: ë¡¤ë°± ì‹¤íŒ¨
            âš ï¸ **ì¦‰ì‹œ ìˆ˜ë™ ê°œì… í•„ìš”!**
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
