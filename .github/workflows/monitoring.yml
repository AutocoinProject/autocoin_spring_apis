name: ğŸ“Š Health Monitoring & Alerts

on:
  schedule:
    # ë§¤ 30ë¶„ë§ˆë‹¤ í”„ë¡œë•ì…˜ ê±´ê°• ìƒíƒœ ì²´í¬
    - cron: '*/30 * * * *'
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ ì¼ì¼ ë¦¬í¬íŠ¸
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of health check to perform'
        required: true
        type: choice
        options:
          - basic
          - detailed
          - performance
        default: 'basic'
      environment:
        description: 'Environment to check'
        required: true
        type: choice
        options:
          - production
          - staging
          - all
        default: 'production'

env:
  PRODUCTION_API_URL: https://api.autocoin.com
  STAGING_API_URL: https://api-staging.autocoin.com

permissions:
  contents: read
  issues: write

jobs:
  # ê¸°ë³¸ í—¬ìŠ¤ì²´í¬
  basic-health-check:
    name: ğŸ¥ Basic Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.schedule == '*/30 * * * *' || inputs.check_type == 'basic' || inputs.check_type == 'all'
    
    outputs:
      production-status: ${{ steps.prod-check.outputs.status }}
      staging-status: ${{ steps.staging-check.outputs.status }}
    
    steps:
      - name: Health Check - Production
        id: prod-check
        if: inputs.environment == 'production' || inputs.environment == 'all' || github.event.schedule
        run: |
          API_URL="${{ env.PRODUCTION_API_URL }}"
          echo "ğŸ” Checking production health: $API_URL"
          
          # Health endpoint check
          if curl -s --max-time 30 "$API_URL/actuator/health" > health.json; then
            STATUS=$(cat health.json | jq -r '.status' 2>/dev/null || echo "UNKNOWN")
            if [ "$STATUS" = "UP" ]; then
              echo "âœ… Production health: $STATUS"
              echo "status=UP" >> $GITHUB_OUTPUT
            else
              echo "âŒ Production health: $STATUS"
              echo "status=DOWN" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Production health check failed - endpoint unreachable"
            echo "status=DOWN" >> $GITHUB_OUTPUT
          fi

      - name: Health Check - Staging
        id: staging-check
        if: inputs.environment == 'staging' || inputs.environment == 'all'
        run: |
          API_URL="${{ env.STAGING_API_URL }}"
          echo "ğŸ” Checking staging health: $API_URL"
          
          if curl -s --max-time 30 "$API_URL/actuator/health" > staging_health.json; then
            STATUS=$(cat staging_health.json | jq -r '.status' 2>/dev/null || echo "UNKNOWN")
            if [ "$STATUS" = "UP" ]; then
              echo "âœ… Staging health: $STATUS"
              echo "status=UP" >> $GITHUB_OUTPUT
            else
              echo "âŒ Staging health: $STATUS"
              echo "status=DOWN" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Staging health check failed - endpoint unreachable"
            echo "status=DOWN" >> $GITHUB_OUTPUT
          fi

      - name: Basic connectivity test
        run: |
          echo "ğŸ”— Testing basic connectivity..."
          
          # Production connectivity
          if curl -s --max-time 10 "${{ env.PRODUCTION_API_URL }}" > /dev/null; then
            echo "âœ… Production connectivity: OK"
          else
            echo "âŒ Production connectivity: FAILED"
          fi

  # ìƒì„¸ ì‹œìŠ¤í…œ ì²´í¬
  detailed-system-check:
    name: ğŸ”¬ Detailed System Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: inputs.check_type == 'detailed' || inputs.check_type == 'all'
    needs: [basic-health-check]
    
    steps:
      - name: Comprehensive Health Analysis
        run: |
          API_URL="${{ env.PRODUCTION_API_URL }}"
          echo "ğŸ” Performing detailed system analysis..."
          
          # Health details
          echo "ğŸ“Š Health Details:"
          if curl -s --max-time 30 "$API_URL/actuator/health" > health_detail.json; then
            cat health_detail.json | jq '.' || echo "Failed to parse health response"
          else
            echo "Health endpoint unavailable"
          fi
          
          # System info
          echo "ğŸ“± Application Information:"
          if curl -s --max-time 30 "$API_URL/actuator/info" > info.json; then
            cat info.json | jq '.' || echo "Failed to parse info response"
          else
            echo "Info endpoint unavailable"
          fi

      - name: Database and Dependencies Check
        run: |
          API_URL="${{ env.PRODUCTION_API_URL }}"
          
          echo "ğŸ—„ï¸ Database Status:"
          if curl -s --max-time 30 "$API_URL/actuator/health" > db_health.json; then
            DB_STATUS=$(cat db_health.json | jq -r '.components.db.status' 2>/dev/null || echo "UNKNOWN")
            echo "Database: $DB_STATUS"
          else
            echo "Database status unavailable"
          fi
          
          echo "ğŸ”´ Redis Status:"
          if curl -s --max-time 30 "$API_URL/actuator/health" > redis_health.json; then
            REDIS_STATUS=$(cat redis_health.json | jq -r '.components.redis.status' 2>/dev/null || echo "UNKNOWN")
            echo "Redis: $REDIS_STATUS"
          else
            echo "Redis status unavailable"
          fi

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-check:
    name: ğŸš€ Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: inputs.check_type == 'performance' || inputs.check_type == 'all'
    
    steps:
      - name: Response Time Test
        run: |
          API_URL="${{ env.PRODUCTION_API_URL }}"
          echo "â±ï¸ Testing response times..."
          
          # Test health endpoint response time
          echo "Testing: /actuator/health"
          RESPONSE_TIME=$(curl -w "%{time_total}" -s --max-time 30 -o /dev/null "$API_URL/actuator/health" || echo "0")
          echo "Response time: ${RESPONSE_TIME}s"
          
          # Alert if response time > 3 seconds
          if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l 2>/dev/null || echo "0") )); then
            echo "âš ï¸ Slow response detected: ${RESPONSE_TIME}s for health endpoint"
          fi

      - name: Memory and System Check
        run: |
          API_URL="${{ env.PRODUCTION_API_URL }}"
          echo "ğŸ§  Checking system metrics..."
          
          # Get available metrics
          if curl -s --max-time 30 "$API_URL/actuator/metrics" > metrics.json; then
            echo "Available metrics:"
            cat metrics.json | jq -r '.names[]' | head -10 || echo "Failed to parse metrics"
          else
            echo "Metrics endpoint unavailable"
          fi

  # ì•Œë¦¼ ë° ë³´ê³ 
  alert-on-failure:
    name: ğŸš¨ Alert on Health Issues
    runs-on: ubuntu-latest
    needs: [basic-health-check]
    if: always() && (needs.basic-health-check.outputs.production-status == 'DOWN' || needs.basic-health-check.outputs.staging-status == 'DOWN')
    
    steps:
      - name: Send alert notification
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#alerts'
          text: |
            ğŸš¨ *Autocoin API Health Alert*
            
            â€¢ **Production**: ${{ needs.basic-health-check.outputs.production-status || 'Not Checked' }}
            â€¢ **Staging**: ${{ needs.basic-health-check.outputs.staging-status || 'Not Checked' }}
            â€¢ **Check Time**: $(date -u)
            
            ğŸ”— **Action Required**: Check application status
            â€¢ Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_PROD }}

  daily-report:
    name: ğŸ“ˆ Daily Health Report
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 9 * * *'
    needs: [basic-health-check, detailed-system-check]
    
    steps:
      - name: Generate daily report
        run: |
          echo "ğŸ“Š Daily Health Report - $(date)"
          echo "================================"
          echo "Production Status: ${{ needs.basic-health-check.outputs.production-status || 'Unknown' }}"
          echo "Staging Status: ${{ needs.basic-health-check.outputs.staging-status || 'Unknown' }}"
          echo "Detailed Check: ${{ needs.detailed-system-check.result || 'Skipped' }}"
          echo "Report generated at: $(date -u)"

      - name: Send daily report
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#daily-reports'
          text: |
            ğŸ“Š *Daily Health Report*
            
            â€¢ **Production**: ${{ needs.basic-health-check.outputs.production-status || 'Unknown' }}
            â€¢ **Staging**: ${{ needs.basic-health-check.outputs.staging-status || 'Unknown' }}
            â€¢ **Report Date**: $(date)
            
            âœ… All systems checked
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_PROD }}
